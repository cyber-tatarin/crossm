<!DOCTYPE html>
{% load static %}
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="{% static 'css/style.css' %}">
        <title>Document</title>
    </head>
    <body>

    {% include "base.html" %}

{% block content %}

        <main class="main">
            <div class="container-padding">
            <div class="container-main">

                    {% if owner %}

                <div class="pop-up-delete">
                        <div class="pop-up-container">
                            <div class="pop-up-body">
                                <p class="pop-up-title">Вы уверены, что хотите удалить это предложение?
                                </p>
                                <div class="pop-up-buttons">
                                    <div class="pop-up-button pop-up-button-cancel">
                                        <button class="button">
                                            <p class="button-p">Отменить</p>
                                        </button>
                                    </div>
                                    <div class="pop-up-button pop-up-button-confirm">
                                        <button class="button">
                                            <p class="button-p">Удалить</p>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                <div class="pop-up-delete-company">
                        <div class="pop-up-container">
                            <div class="pop-up-body">
                                <p class="pop-up-title">Вы уверены, что хотите удалить эту компанию?
                                </p>
                                <div class="pop-up-buttons">
                                    <div class="pop-up-button pop-up-button-cancel company-cancel">
                                        <button class="button">
                                            <p class="button-p">Отменить</p>
                                        </button>
                                    </div>
                                    <div class="pop-up-button pop-up-button-confirm company-delete">
                                        <button class="button">
                                            <p class="button-p">Удалить</p>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                <div class="profile">
                    <div class="profile-owner">

                         <div class="profile-user-left">

                            <div class="profile-user__logo">
                                {% if company.photo %}
                                <img id="image" class="profile-user__img" src="{{company.photo.url}}">
                                <a id="dela" onclick="deletePhoto({{company.id}})" class="delete-photo">Удалить фото</a>
                                {% else %}
                                <form id="files" method="post" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <label style="width: 135px; height: 135px; background-color: transparent; border-radius: 50%; position: absolute;" class="label-image">
                                    <img id="image" class="profile-user__img" src="" style="visibility: hidden">
                                    <a id="dela" onclick="deletePhoto({{company.id}})" class="delete-photo" style="visibility: hidden;">Сохранить фото</a>
                                    <input name="id" type="hidden" value="{{company.id}}">
                                    <input style="display: none;" name="image" type="file" />
                                    <button style="display: none;">Сохранить</button>
                                    </label>
                                </form>
                                
                                {% endif %}
                            </div>

                        </div>
                        <div class="profile-user-right">
                            <h1 class="profile-user__name">{{company.title}}</h1>
                            <div class="owner-info">
                                <div class="owner-info-item">
                                    <span class="profile-user__city">Страна:&nbsp</span>
                                    <span class="profile-user__city__name">{{company.country_of_res.country}}</span>
                                </div>
                            
                                <div class="owner-info-item">
                                    <span class="profile-user__city">УНП:&nbsp</span>
                                    <span class="profile-user__city__name">{% if company.status %} {{company.status}} {% else %} Не проверен {%endif %}</span>
                                </div>
                          
                                <div class="owner-info-item">
                                    <span class="profile-user__city">Ниша:&nbsp</span>
                                    <span class="profile-user__city__name">{{company.niche}}</span>
                                </div>
                            
                                <div class="owner-info-item">
                                    <a style="display: block;" href="{{company.link}}" style="margin-bottom: 28px;" class="company-link">{{company.link}}</a>
                                </div>
                            </div>
                            <div class="profile-user__buttons">
                                <div class="button-240px">
                                    <button class="button" onclick="window.location.href = '{% url 'companies:update-company' company.id %}'">
                                        <p class="button-p">Редактировать компанию</p>
                                    </button> 
                                </div>
                                <div class="button-240px">
                                    <button id="cmp-{{company.id}}" class="button button-for-pop-up company-del-button">
                                        <p class="button-p">Удалить компанию</p>
                                    </button> 
                                </div>
                                <div class="button-240px">
                                    <button class="button" onclick="window.location.href = '{% url 'offers:create-offer' company.id %}?next={{ request.path|urlencode }}'">
                                        <p class="button-p">Добавить предложение</p>
                                    </button> 
                                </div>
                                <div class="button-240px">
                                    <button class="button button-ynp">
                                        <p class="button-p">Проверить УНП</p>
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                {% else %}

                <div class="profile">
                    <div style="align-items: center;" class="profile-owner">
                        <div class="profile-user-left">
                            <div class="profile-user__logo">
                                {% if company.photo %}
                                <img id="image" class="profile-user__img" src="{{company.photo.url}}">
                                {% else %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="profile-user-right">
                            <h1 class="profile-user__name">{{company.title}}</h1>
                            <div class="owner-info-no-bottom">
                                <div class="owner-info-item">
                                    <span class="profile-user__city">Страна:&nbsp</span>
                                    <span class="profile-user__city__name">{{company.country_of_res.country}}</span>
                                </div>

                                <div class="owner-info-item">
                                    <span class="profile-user__city">УНП:&nbsp</span>
                                    <span class="profile-user__city__name">{% if company.status %} {{company.status}} {% else %} Не проверен {%endif %}</span>
                                </div>

                                <div class="owner-info-item">
                                    <span class="profile-user__city">Ниша:&nbsp</span>
                                    <span class="profile-user__city__name">{{company.niche}}</span>
                                </div>

                                <div class="owner-info-item">
                                    <a style="display: block;" href="{{company.link}}" style="margin-bottom: 28px;" class="company-link">{{company.link}}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% endif %}

                <section style="display: flex; column-gap: 24px; margin-bottom: 24px;">

                    <div class="pop-up-images">
                    <div class="pop-up-container">
                        <div class="pop-up-images-body">
                            <div class="pop-up-exit">

                            </div>
                            <div style="margin-bottom: 32px;" class="flex">
                            <p class="pop-up-images-title"></p>
                            <div style="margin-right: 16px;" class="">
                                <span class="profile-user__city">Услуга:&nbsp</span>
                                <span class="profile-user__city__name pop-up-input-title"></span>
                            </div>
                            <div class="">
                                <span class="profile-user__city">Цена купона:&nbsp</span>
                                <span class="profile-user__city__name pop-up-input-price"></span>
                            </div>
                            </div>
                            <div class="images-container">
<!--                                <img src="" alt="" class="pop-up-img">-->
<!--                                <div style="margin-top: 32px" class=""></div>-->
                            </div>
                        </div>
                    </div>
                </div>

                    {% if reviews %}
                    <div class="container-scroll">
                        {% else %}
                         <div style="width: 100%; overflow: auto;" class="container-scroll">
                             {% endif %}
                        
                        <div class="flex">
                            <div class="reviews-container">
                                <div class="reviews-info">
                                    <div class="main-title profile-title">
                                        Отзывы&nbsp(11)
                                    </div>
                                    <div class="rating-small">
                                        <span class="active"></span>	
                                        <span class="active"></span>    
                                        <span class="active"></span>  
                                        <span class="active"></span>    
                                        <span class="not-active"></span>
                                    </div>
                                    <div class="count-reviews">4&nbspиз&nbsp5</div>
                                    <div class="reviews-stars"></div>
                                    <a href="#" class="read-reviews">Читать&nbspвсе&nbspотзывы</a>
                                    <a href="#" class="write-reviews">Написать&nbspотзыв</a>
                                </div>

                                <div class="flex-column">
                                    {% if reviews %}
                                    {% else %}
                                     <p class="p-no-reviews">Отзывов пока нет</p>
                                    {% endif %}

<!--                                <div class="profile-user-small">-->
<!--                                    <div class="profile-user-left">-->
<!--                                        <div class="profile-user__logo-small"></div>-->
<!--                                    </div>-->
<!--                                <div class="profile-user-right">-->
<!--                                    <h1 class="profile-user__name-small">Станислав Брониславович</h1>-->
<!--                                    <div class="city-info-small info-flex">-->
<!--                                        <div class="">-->
<!--                                            <span class="profile-user__city-small">Город:&nbsp</span>-->
<!--                                            <span class="profile-user__city__name-small">Минск</span>-->
<!--                                        </div>-->
<!--                                        <div class="date-review">15.01.2023</div>-->
<!--                                    </div>-->
<!--                                    <div class="profile__remark-small">-->
<!--                                        Пишитие, пожалуйста с 9 до 20 в вайбер на номер телфона, укакзанный в контактах. Я люблю пельмени. Я работал с этой компанией 10 лет, все очень круто, парни молодцы!-->
<!--                                    </div>-->
<!--                                    <div class="flex">-->
<!--                                        <a href="#" class="read-reviews">Читать&nbspвсе&nbspотзывы</a>-->
<!--                                        <a href="#" class="write-reviews">Написать&nbspотзыв</a>-->
<!--                                </div>-->
<!--                                </div>-->
<!--                            </div>-->

                        <div style="padding-top: 40px;" class=""></div>

                                </div>
                           
                            </div>
                        </div>
                      </div>


                        {% if reviews %}
                        <div class="container">
                            {% else %}
                            <div style="width: 100%;" class="container">
                                {% endif %}
                            <h2 class="main-title">Контакты</h2>

                            <!-- с текстом -->
                            {% if company.owner.profile_set.all.0.bio %}
                             <div style="margin-bottom: 16px;" class="profile-user-small">
                                <div class="profile-user-left">
                                    <div class="profile-user__logo-small"></div>
                                </div>
                                <div class="profile-user-right">
                                <h1 class="profile-user__name-small">{{company.owner.first_name}} {{company.owner.last_name}}</h1>
                                <div style="margin-bottom: 0px;" class="city-info-small">
                                    <span class="profile-user__city-small">Город:&nbsp</span>
                                    <span class="profile-user__city__name-small">{{company.owner.profile_set.all.0.city.city}}</span>
                                </div>

                                    <div class="city-info-small">
                                    <span class="profile-user__city-small">Должность:&nbsp</span>
                                    <span class="profile-user__city__name-small">{{company.owner.profile_set.all.0.city.city}}</span>
                                </div>

                                <div class="profile__remark-small-wout-margin">
                                    {{company.owner.profile_set.all.0.bio}}
                                </div>
                                </div>
                            </div>

                            {% else %}

                            <!-- без текста -->

                            <div style="margin-bottom: 16px; align-items: center;" class="profile-user-small">
                                <div class="profile-user-left">
                                    <div class="profile-user__logo-small"></div>
                                </div>
                                <div class="profile-user-right">
                                <h1 class="profile-user__name-small">{{company.owner.first_name}} {{company.owner.last_name}}</h1>
                                <div class="">
                                    <span class="profile-user__city-small">Город:&nbsp</span>
                                    <span class="profile-user__city__name-small">{{company.owner.profile_set.all.0.city.city}}</span>
                                </div>
                                </div>
                            </div>

                            {% endif %}


                            <div class="profile-user__mail">
                                <p class="user__mail">{{company.owner.email}}</p>
                            </div>
                            {% if company.owner.profile_set.all.0.phone_num_show %}
                            <div class="profile-user__phone">
                                <p class="user__phone">{{company.owner.profile_set.all.0.phone_num}}</p>
                                    {% if owner %}
                                <img src="{% static 'images/edit.png' %}" alt="фото" class="user__phone__logo">
                                {% endif %}
                        </div>
                            {% endif %}
                        </div>
                        </div>
                    </div>
                </section>

                {% if owner %}

                <section>
                    <div class="card-container">
                        <div class="flex-32-24">
                        <p class="main-title">
                            Предложения
                        </p>
                        <a href="{% url 'offers:create-offer' company.id %}?next={{ request.path|urlencode }}" class="add-offer-no-change">Добавить предложение</a>
                    </div>
                        {% if not company.offers_set.all %}
                        <p style="position: static; margin-top: -10px" class="p-no-reviews">
                       У Вашей компании пока нет предложений
                        </p>
                        {% endif %}

                            <div class="grid">
                                <div class="grid-sizer"></div>
                                <div class="gutter-sizer"></div>
                                
                {% for offer in company.offers_set.all %}

                                <div id="offer-{{offer.id}}" class="company-card grid-item">

                                    <hr class="card-hr-solid">
                                    <div class="company-card-main"> 
                                        <div class="company-content-left">
                                            <div style="margin-bottom: 12px;" class="">
                                                <p class="company-key">{{offer.type}}</p>
                                                <p class="company-value no-bottom" >{{offer.title}}</p>
                                            </div>
                                            <div class=""> 
                                                <p class="company-key">Розничная цена</p>
                                                <p class="company-value no-bottom">{{offer.retail_price}} {{offer.currency}}</p>
                                            </div>
                                        </div>
                                        <!-- <div class="hr-solid-vertical"></div> -->
                                        <div class="company-content-right">
                                            <div class="flex-content-no-gap">
                                                <div class="">
                                                <p class="company-key">Количество купонов</p>
                                                <p class="company-value">От {{offer.amount_min}} до {{offer.amount_max}}</p>
                                                </div>
                                                
                                                <div class="">
                                                <p class="company-key">Цена купона</p>
                                                <p class="company-value no-bottom">{{offer.coupon_price}} {{offer.currency}}</p>
                                                </div>    
                                            </div>
                                        </div> 
                                    </div>
                
                                    <hr class="card-hr-solid">                
                                    <div class="company-card-main"> 
                                        <div class="card-button-single">
                                        <div class="flex-content">
                                            {% if offer.has_photo %}
                                            <button id="get-img-{{offer.id}}" style="margin-top: -2px; max-width: 100%;" class="button check-pop-up">
                                                <p class="button-p">Посмотреть вложения</p>
                                            </button>
                                            {% else %}
                                            <button  style="margin-top: -2px; max-width: 100%;" class="button button-ynp">
                                                <p class="button-p">Посмотреть вложения</p>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    </div>
                                    <hr style="margin-bottom: 20px;" class="card-hr-solid">
                                    <div class="company-card-buttons">
                                        <button class="button button-282px" onclick="window.location.href = '{% url 'offers:update-offer' offer.id %}?next={{ request.path|urlencode }}'">
                                            <p class="button-p">Редактировать предложение</p>
                                        </button>
                                        <button id="of-del-{{offer.id}}" class="button button-282px button-for-pop-up offer-del-button">
                                            <p class="button-p">Удалить предложение</p>
                                        </button>
                                    </div>
                                </div>

                                {% endfor %}

                                </div>
                            </div>
                </section>

                {% else %}

                <section>
                    <div class="card-container">
                        <div class="flex-32-24">
                        <p class="main-title">
                            Предложения
                        </p>
                    </div>
                        {% if not company.offers_set.all %}
                        <p style="position: static; margin-top: -10px" class="p-no-reviews">
                       У этой компании пока нет предложений
                        </p>
                        {% endif %}
                            <div class="grid">
                                <div class="grid-sizer"></div>
                                <div class="gutter-sizer"></div>

                                {% for offer in company.offers_set.all %}

                <div class="company-card grid-item">

                                    <hr class="card-hr-solid">
                                    <div class="company-card-main">
                                        <div class="company-content-left">
                                            <div style="margin-bottom: 12px;" class="">
                                                <p class="company-key">{{offer.type}}</p>
                                                <p class="company-value no-bottom">{{offer.title}} </p>
                                            </div>
                                            <div class="">
                                                <p class="company-key">Розничная цена</p>
                                                <p class="company-value no-bottom">{{offer.retail_price}} {{offer.currency}}</p>
                                            </div>
                                        </div>
                                        <!-- <div class="hr-solid-vertical"></div> -->
                                        <div class="company-content-right">
                                            <div class="flex-content-no-gap">
                                                <div class="">
                                                <p class="company-key">Количество купонов</p>
                                                <p class="company-value">От {{offer.amount_min}} до {{offer.amount_max}}</p>
                                                </div>

                                                <div class="">
                                                <p class="company-key">Цена купона</p>
                                                <p class="company-value no-bottom">{{offer.coupon_price}} {{offer.currency}}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <hr class="card-hr-solid">
                                    <div class="company-card-main">
                                        <div class="card-button-single">
                                        <div class="flex-content">
                                            {% if offer.has_photo %}
                                            <button id="get-img-{{offer.id}}" style="margin-top: -2px; max-width: 100%;" class="button check-pop-up">
                                                <p class="button-p">Посмотреть вложения</p>
                                            </button>
                                            {% else %}
                                            <button  style="margin-top: -2px; max-width: 100%;" class="button button-ynp">
                                                <p class="button-p">Посмотреть вложения</p>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    </div>
                                    <hr class="card-hr-solid">
                                </div>

                    {% endfor %}

                            </div>
                    </div>
                </section>

                {% endif %}

            </div>
        </div>
        </main>

        {% include "footer.html" %}

<form id="files" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input name="id" type="hidden" value="{{company.id}}">
    <input name="image" type="file" />
    <button>Сохранить</button>
</form>

        <!-- <div class="bottom-margin"></div> -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!--        <script src="{% static 'js/sort-companies.js' %}"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D" crossorigin="anonymous" async></script>

    <script>

        document.querySelector('.label-image').addEventListener('change', (el) => {
            console.log(el);
            document.querySelector('.label-image').classList.toggle('label-iamge-change');
            console.log('added')
            document.querySelector('.delete-photo').style.visibility = 'visible'
        })

let cardId;

window.onload = () => {
    masonry = new Masonry('.grid', {
    gutter: '.gutter-sizer',
    itemSelector: '.grid-item',
    columnWidth: '.grid-sizer',
    percentPosition: true,
    transitionDuration: '0.2s',
  });
};
    </script>

        {% if owner %}

    <script>
document.querySelectorAll('.offer-del-button').forEach((el) => {
    el.addEventListener('click', () => {
        document.querySelector('.pop-up-delete').classList.toggle('pop-up-delete-active');
        cardId = parseInt(el.id.replace(/[^\d]/g, ''))

        })
})

document.querySelector('.pop-up-button-cancel').addEventListener('click', () => {
    document.querySelector('.pop-up-delete').classList.remove('pop-up-delete-active');
})

document.querySelector('.pop-up-button-confirm').addEventListener('click', () => {

    $.ajax ({
        url: '{% url "offers:delete-offer" %}',
        data: {
            'id': cardId,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        dataType: 'json',
        success: function(data) {
            $("#offer-" + cardId).remove();
            masonry = new Masonry('.grid', {
            gutter: '.gutter-sizer',
            itemSelector: '.grid-item',
            columnWidth: '.grid-sizer',
            percentPosition: true,
            transitionDuration: '0.2s',
        });
        },
        type: "POST",
    });

    document.querySelector('.pop-up-delete').classList.remove('pop-up-delete-active');
})

function deletePhoto(id){

    $.ajax ({
        url: '{% url "companies:delete-photo" %}',
        data: {
            'id': id,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        dataType: 'json',
        success: function(data) {
            $("#image").style = "visibility: hidden";
            $("#dela").style = "visibility: hidden";
        },
        type: "POST",
    });
    }

$("form#files").submit(function(){

    var formData = new FormData($(this)[0]);

    $.ajax({
        url: '{% url "companies:upload-photo" %}',
        type: 'POST',
        data: formData,
        async: false,
        success: function (data) {

                    let out = data.image
                    console.log(out)

              document.querySelector(".profile-user__img").src=out;

        },
        cache: false,
        contentType: false,
        processData: false
    });

    return false;
});

</script>

<script>


document.querySelectorAll('.company-del-button').forEach((el) => {
    el.addEventListener('click', () => {
        document.querySelector('.pop-up-delete-company').classList.toggle('pop-up-delete-company-active');
        cmpId = parseInt(el.id.replace(/[^\d]/g, ''))

        })
})

document.querySelector('.company-cancel').addEventListener('click', () => {
    document.querySelector('.pop-up-delete-company').classList.remove('pop-up-delete-company-active');
})

document.querySelector('.company-delete').addEventListener('click', () => {

    $.ajax ({
        url: '{% url "companies:delete-company" %}',
        data: {
            'id': cmpId,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        dataType: 'json',
        success: function(data) {
            window.location.href = "{% url 'offers:catalog' %}"

        },
        type: "POST",
    });

    document.querySelector('.pop-up-delete-company').classList.remove('pop-up-delete-company-active');
})

</script>

    {% else %}

    <script>

document.querySelectorAll('.check-pop-up').forEach((el) => {
            el.addEventListener('click', () => {
                getImages(parseInt(el.id.replace(/[^\d]/g, '')), el);
            })
        })
         document.querySelector('.pop-up-exit').addEventListener('click', () => {
            document.querySelector('.pop-up-images').classList.remove('pop-up-delete-active');
        })

function getImages(id, el)
{
    $.ajax(
    {
        url: '{% url "offers:get-images" %}',
        data: {
            'id': id,
        },
        dataType: 'json',
        success: function(data) {
                 const output = document.querySelector(".images-container")
                 let images = "";

                 for (let i = 0; i < data.images.length; i++) {
                 const out = data.images[i]
                 console.log(out);

                    images += `
                <img src="${out}" alt="image" class="pop-up-img">
              `;
                 }
<!--                 images += ` <div style="margin-top: 32px" class=""></div> `-->
                 console.log(images);
                 output.innerHTML = images;
                 setTimeout(() => {}, "500")
<!--                document.querySelector('.pop-up-images-title').innerHTML = el.parentNode.parentNode.parentNode.parentNode.children[0].children[1].innerHTML-->
                document.querySelector('.pop-up-input-title').innerHTML = el.parentNode.parentNode.parentNode.parentNode.parentNode.children[2].children[1].children[0].children[0].children[1].innerHTML
                document.querySelector('.pop-up-input-price').innerHTML = el.parentNode.parentNode.parentNode.parentNode.parentNode.children[2].children[1].children[0].children[1].children[1].innerHTML
                document.querySelector('.pop-up-images').classList.toggle('pop-up-delete-active');
        },
        type: "GET",

    });

}

</script>

{% endif %}

    </body>
{% endblock %}
</html>